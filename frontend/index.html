<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Website Knowledge Chatbot</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f5f6fa;
            margin: 0;
            padding: 20px;
            max-width: 900px;
            margin: auto;
        }

        .chat-box,
        .chat-references {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ccc;
        }

        .user-entry {
            background: #d1f0d1;
            text-align: right;
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
        }

        .bot-entry {
            background: #e1e9f5;
            text-align: left;
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
        }

        input,
        textarea,
        select,
        button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        button {
            background: #4a69bd;
            color: white;
            border: none;
            cursor: pointer;
        }

        button:hover {
            background: #3b55a1;
        }

        #buttons {
            display: flex;
            gap: 10px;
        }

        #buttons button {
            flex: 1;
        }
    </style>
</head>

<body>
    <h2>üåé Webpage Knowledge Chatbot</h2>

    <input id="urlInput" type="text" placeholder="Enter website URL..." />
    <button onclick="addUrl()">Scrape Website</button>

    <div class="chat-box">
        <textarea id="questionInput" placeholder="Ask a question..." onkeypress="handleKey(event)"></textarea>
        <div id="buttons">
            <button onclick="ask()">Ask</button>
            <button onclick="clearChat()">üßπ Clear Chat</button>
        </div>
        <div id="answers"></div>
    </div>

    <h3>üîó Scraped Pages</h3>
    <div id="scrapedLinks" class="chat-references"></div>

    <div id="pagination" class="chat-references"></div>

    <h3>üåê Reference Domain</h3>
    <select id="siteDropdown" onchange="showGraph(this.value)">
        <option>Select a site...</option>
    </select>

    <div id="graphContainer" class="chat-references"></div>

    <script>
        async function addUrl() {
            const url = document.getElementById('urlInput').value;
            const res = await fetch("/add_url", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ url })
            });
            const data = await res.json();
            alert(data.message);
            renderLinks(data.scraped_links || []);
            updateDropdown();
        }

        async function ask() {
            const question = document.getElementById('questionInput').value;
            if (!question.trim()) return;

            const userBox = document.createElement('div');
            userBox.className = 'user-entry';
            userBox.innerText = 'üßë ' + question;
            document.getElementById('answers').appendChild(userBox);

            const botBox = document.createElement('div');
            botBox.className = 'bot-entry';
            botBox.innerText = 'ü§ñ ...';
            document.getElementById('answers').appendChild(botBox);

            const res = await fetch("/ask", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ question })
            });
            const data = await res.json();
            botBox.innerText = 'ü§ñ ' + data.answer;
        }

        function clearChat() {
            document.getElementById("answers").innerHTML = "";
        }

        function handleKey(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                ask();
            }
        }

        function renderLinks(links) {
            const container = document.getElementById('scrapedLinks');
            container.innerHTML = "";
            links.forEach(link => {
                container.innerHTML += `<div><a href="${link}" target="_blank">${link}</a></div>`;
            });
        }

        async function updateDropdown() {
            const res = await fetch("/get_urls");
            const data = await res.json();
            const dropdown = document.getElementById("siteDropdown");
            dropdown.innerHTML = `<option>Select a site...</option>`;
            data.urls.forEach(url => {
                dropdown.innerHTML += `<option value="${url}">${url}</option>`;
            });
        }

        function showGraph(url) {
            const graphDiv = document.getElementById("graphContainer");
            graphDiv.innerHTML = `<iframe src="/static/graphs/${new URL(url).hostname}.json" width="100%" height="400px"></iframe>`;
        }

        window.onload = updateDropdown;
    </script>
</body>

</html>